<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | VibeWealth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="./styles-dashboard.css" />
</head>

<body>

<div class="page">
    <div class="header">
        <div class="header-title">VibeWealth</div>
        <div class="header-subtitle">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ–±–∑–æ—Ä</div>
    </div>

    <div class="balance-card">
        <div>
            <div class="balance-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-amount" id="balanceAmount">0 ‚Ç∏</div>
        </div>
        <button class="btn-add" id="goAddExpense">+</button>
    </div>

    <div class="section-title">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
    <div class="categories">

        <div class="category-item">
            <div class="category-name">–ï–¥–∞</div>
            <div class="category-value" id="cat-food">0 ‚Ç∏</div>
        </div>

        <div class="category-item">
            <div class="category-name">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
            <div class="category-value" id="cat-transport">0 ‚Ç∏</div>
        </div>

        <div class="category-item">
            <div class="category-name">–ë–∞—Ä—ã</div>
            <div class="category-value" id="cat-bars">0 ‚Ç∏</div>
        </div>

        <div class="category-item">
            <div class="category-name">–®–æ–ø–ø–∏–Ω–≥</div>
            <div class="category-value" id="cat-shopping">0 ‚Ç∏</div>
        </div>

    </div>

    <div class="section-title">–¶–µ–ª–∏ & –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</div>
    <div class="goals">

        <div class="goal">
            <div class="goal-header">
                <span class="goal-title">–ü–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</span>
                <span class="goal-value">120 000 / 300 000 ‚Ç∏</span>
            </div>
            <div class="goal-progress">
                <div class="goal-progress-fill" style="width: 40%;"></div>
            </div>
        </div>

        <div class="goal">
            <div class="goal-header">
                <span class="goal-title">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</span>
                <span class="goal-value">40 000 / 150 000 ‚Ç∏</span>
            </div>
            <div class="goal-progress">
                <div class="goal-progress-fill" style="width: 27%;"></div>
            </div>
        </div>

    </div>

</div>


<script>
    Telegram.WebApp.ready();

    const tgUser = Telegram.WebApp.initDataUnsafe?.user;
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
const cachedDashboard = JSON.parse(localStorage.getItem("dashboardCache") || "null");

if (cachedDashboard) {
    console.log("üíæ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ cache:", cachedDashboard);

    document.getElementById("balanceAmount").textContent =
        cachedDashboard.balance + " ‚Ç∏";

    cachedDashboard.categories.forEach(c => {
        if (c.category === "food") {
            document.getElementById("cat-food").textContent = c.sum + " ‚Ç∏";
        }
        if (c.category === "transport") {
            document.getElementById("cat-transport").textContent = c.sum + " ‚Ç∏";
        }
        if (c.category === "bars") {
            document.getElementById("cat-bars").textContent = c.sum + " ‚Ç∏";
        }
        if (c.category === "shopping") {
            document.getElementById("cat-shopping").textContent = c.sum + " ‚Ç∏";
        }
    });
}


    if (!tgUser) {
        alert("–û—Ç–∫—Ä–æ–π Mini App —á–µ—Ä–µ–∑ Telegram");
    }

    // –ü–†–û–°–¢–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø
    const btnAddExpense = document.getElementById("goAddExpense");

    btnAddExpense.onclick = () => {
        window.location.href = "expense.html"; // –ø–æ–∑–∂–µ —Å–æ–∑–¥–∞–¥–∏–º
    };
    fetch("https://mbzdqomfhntjgihknwfp.supabase.co/functions/v1/get-dashboard-data", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ telegram_id: tgUser.id })
})
.then(res => res.json())
.then(data => {
  console.log(data);
    localStorage.setItem("dashboardCache", JSON.stringify(data));


  // –≤—Å—Ç–∞–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
  document.getElementById("balanceAmount").textContent =
    data.balance + " ‚Ç∏";
    // –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –∏—Ö
let cached = JSON.parse(localStorage.getItem("cachedExpenses") || "[]");

if (cached.length > 0) {
    
    // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—É–º–º—É –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
    let additions = cached.reduce((acc, c) => acc + c.amount, 0);
    
    let current = parseInt(
        document.getElementById("balanceAmount").textContent.replace(" ‚Ç∏", "")
    );

    document.getElementById("balanceAmount").textContent =
        (current - additions) + " ‚Ç∏";
}

    // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
data.categories.forEach(c => {
    if (c.category === "food") {
        document.getElementById("cat-food").textContent = c.sum + " ‚Ç∏";
    }
    if (c.category === "transport") {
        document.getElementById("cat-transport").textContent = c.sum + " ‚Ç∏";
    }
    if (c.category === "bars") {
        document.getElementById("cat-bars").textContent = c.sum + " ‚Ç∏";
    }
    if (c.category === "shopping") {
        document.getElementById("cat-shopping").textContent = c.sum + " ‚Ç∏";
    }
});

})
.catch(() => {
  Telegram.WebApp.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ");
});

</script>

</body>
</html>
