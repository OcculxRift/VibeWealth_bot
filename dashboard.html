<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VibeWealth | Dashboard</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#00E4A8",
            bgDark: "#07211B",
            cardDark: "#0E332A"
          },
          fontFamily: {
            main: ["Plus Jakarta Sans", "sans-serif"]
          },
          borderRadius: {
            card: "20px"
          }
        }
      }
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body class="font-main bg-bgDark text-white">

<div id="container" class="px-4 py-5 min-h-screen">

  <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Финансовый обзор</h2>
      <button id="addBtn" class="text-3xl leading-none">+</button>
  </div>

  <!-- Баланс -->
  <div class="bg-cardDark rounded-card p-4 mb-6">
      <p class="text-sm opacity-70">Текущий баланс</p>
      <p id="balance" class="text-3xl font-bold mt-1">0 ₸</p>
  </div>

  <!-- Диаграмма расходов -->
  <div class="flex flex-col justify-center items-center mb-6">
      <svg id="chart" width="170" height="170" viewBox="0 0 36 36">
          <!-- Основа -->
          <circle cx="18" cy="18" r="15.9" fill="none" stroke="#083328" stroke-width="3"/>
          <!-- Категории — динамика -->
          <circle id="foodArc" cx="18" cy="18" r="15.9" fill="none" stroke="#FF8C69" stroke-width="3" stroke-dasharray="0 100"/>
          <circle id="transportArc" cx="18" cy="18" r="15.9" fill="none" stroke="#FFD700" stroke-width="3" stroke-dasharray="0 100"/>
          <circle id="barsArc" cx="18" cy="18" r="15.9" fill="none" stroke="#8A2BE2" stroke-width="3" stroke-dasharray="0 100"/>
          <circle id="shoppingArc" cx="18" cy="18" r="15.9" fill="none" stroke="#00CED1" stroke-width="3" stroke-dasharray="0 100"/>
      </svg>

      <p class="opacity-80 text-sm mt-3">Всего расходов</p>
      <p id="totalExpenses" class="text-2xl font-bold">0 ₸</p>
  </div>

  <!-- Категории -->
  <h3 class="text-lg font-bold mb-2">Категории</h3>

  <div class="space-y-3" id="categories">
    <!-- категории подставятся динамически -->
  </div>

  <!-- Цели -->
  <h3 class="text-lg font-bold mt-8 mb-2">Цели накоплений</h3>

  <div id="goals">
     <!-- пока статично — позже сделаем динамически -->
     <div class="mb-4">
         <p class="flex justify-between text-sm">
            <span>Подушка</span>
            <span>120 000 / 300 000</span>
         </p>
         <div class="bg-gray-700 rounded-full h-2 mt-1">
           <div class="bg-primary h-2 rounded-full" style="width: 40%;"></div>
         </div>
     </div>
  </div>

</div>

<script>
Telegram.WebApp.ready();
const user = Telegram.WebApp.initDataUnsafe?.user;

document.getElementById("addBtn").onclick = () => {
    window.location.href = "expense.html";
};

// Загружаем данные
fetch("https://mbzdqomfhntjgihknwfp.supabase.co/functions/v1/get-dashboard-data", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ telegram_id: user.id })
})
.then(res => res.json())
.then(data => {
    console.log(data);

    document.getElementById("balance").textContent = data.balance + " ₸";
    document.getElementById("totalExpenses").textContent = data.total_expenses + " ₸";

    renderCategories(data.categories);
    renderPie(data.categories);
});

function renderCategories(list) {
    let html = "";
    list.forEach(el => {
        html += `
         <div class="bg-cardDark rounded-card p-3 flex justify-between">
            <span>${el.category}</span>
            <strong>${el.sum} ₸</strong>
         </div>`;
    });
    document.getElementById("categories").innerHTML = html;
}

function renderPie(categories) {
    let total = categories.reduce((acc, v) => acc + v.sum, 0);

    let offset = 0;
    categories.forEach((c, index) => {
        let arc = Math.round(c.sum / total * 100);
        let id = {
          food: "foodArc",
          transport: "transportArc",
          bars: "barsArc",
          shopping: "shoppingArc"
        }[c.category];

        if (!id) return;

        document.getElementById(id).setAttribute("stroke-dasharray", `${arc}, 100`);
        document.getElementById(id).setAttribute("stroke-dashoffset", -offset);

        offset += arc;
    });
}
</script>

</body>
</html>
