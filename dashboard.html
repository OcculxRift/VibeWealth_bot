<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VibeWealth | Dashboard</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#00E4A8",
            bgDark: "#07211B",
            cardDark: "#0E332A"
          },
          fontFamily: {
            main: ["Plus Jakarta Sans", "sans-serif"]
          },
          borderRadius: {
            card: "20px"
          }
        }
      }
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body class="font-main bg-[#051E17] text-white">

<div id="container" class="px-4 py-4 min-h-screen space-y-6">

    <!-- Header -->
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold">Финансовый обзор</h2>
        <button id="addBtn" class="text-2xl leading-none px-2 rounded-full bg-[#00E4A8] text-black shadow-md">+</button>
    </div>

    <!-- Balance Card -->
    <div class="rounded-2xl bg-[#0C2C24] px-5 py-5 shadow-xl border border-[#0F3A2F]">
        <p class="text-sm opacity-70 mb-1">Текущий баланс</p>
        <p id="balance" class="text-4xl font-extrabold tracking-tight">0 ₸</p>
    </div>

    <!-- Pie chart block -->
    <div class="rounded-2xl bg-[#0C2C24] px-5 py-6 shadow-xl border border-[#0F3A2F] text-center">

        <div class="flex justify-center">
            <svg id="chart" width="200" height="200" viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="15.8" stroke="#113D32" stroke-width="3" fill="none"/>
                <circle id="foodArc" cx="18" cy="18" r="15.8" stroke="#FF8D6F" stroke-width="3" fill="none" stroke-dasharray="0 100"/>
                <circle id="transportArc" cx="18" cy="18" r="15.8" stroke="#FFD853" stroke-width="3" fill="none" stroke-dasharray="0 100"/>
                <circle id="barsArc" cx="18" cy="18" r="15.8" stroke="#A46CFF" stroke-width="3" fill="none" stroke-dasharray="0 100"/>
                <circle id="shoppingArc" cx="18" cy="18" r="15.8" stroke="#33F1CA" stroke-width="3" fill="none" stroke-dasharray="0 100"/>
            </svg>
        </div>

        <p class="text-sm mt-2 opacity-70">Всего расходов</p>
        <p id="totalExpenses" class="text-3xl font-extrabold">0 ₸</p>

    </div>


    <!-- Categories -->
    <div>
        <div class="text-lg font-semibold mb-3">Категории расходов</div>

        <div id="categories" class="space-y-3"></div>
    </div>

</div>


<script>
Telegram.WebApp.ready();
const user = Telegram.WebApp.initDataUnsafe?.user;

document.getElementById("addBtn").onclick = () => {
    window.location.href = "expense.html";
};

// Load data
fetch("https://mbzdqomfhntjgihknwfp.supabase.co/functions/v1/get-dashboard-data", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ telegram_id: user.id })
})
.then(res => res.json())
.then(data => {
    console.log(data);

    document.getElementById("balance").textContent = data.balance + " ₸";
    document.getElementById("totalExpenses").textContent = data.total_expenses + " ₸";

    renderCategories(data.categories);
    renderPie(data.categories);
});


function renderCategories(list) {
    let html = "";

    list.forEach(el => {
        html += `
        <div class="flex justify-between items-center bg-[#0A2922] px-4 py-4 rounded-xl shadow-lg border border-[#0F3A2F] hover:bg-[#0D3329] transition">
            <div>
                <p class="font-semibold text-base capitalize">${el.category}</p>
                <p class="text-xs opacity-60">за период</p>
            </div>
            <p class="font-bold text-xl">${el.sum} ₸</p>
        </div>
        `;
    });

    document.getElementById("categories").innerHTML = html;
}


function renderPie(categories) {
    let total = categories.reduce((acc, v) => acc + v.sum, 0);
    let offset = 25;

    categories.forEach(c => {
        let id = {
            food: "foodArc",
            transport: "transportArc",
            bars: "barsArc",
            shopping: "shoppingArc"
        }[c.category];

        if (!id) return;

        let arc = Math.round((c.sum / total) * 100);
        document.getElementById(id).setAttribute("stroke-dasharray", arc + ", 100");
        document.getElementById(id).setAttribute("stroke-dashoffset", -offset);

        offset += arc;
    });
}

</script>

</body>
</html>
